
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Период                     = Параметры.Период;
	Организация                = Параметры.Организация;
	СчетУчета                  = Параметры.СчетУчета;
	ДокументСсылка             = Параметры.ДокументСсылка;
	КлючСтроки                 = Параметры.КлючСтроки;
	ОграничитьПериодОсмотра    = Параметры.ОграничитьПериодОсмотра;
	ИмяДокумента               = ДокументСсылка.Метаданные().Имя;
	
	Если ЗначениеЗаполнено(Параметры.АдресТаблицыНалоговыйАгентНДСВХранилище) Тогда
		АдресТаблицыНалоговыйАгентНДСВХранилище = Параметры.АдресТаблицыНалоговыйАгентНДСВХранилище;
		ТаблицаНалоговыйАгентНДС = ПолучитьИзВременногоХранилища(АдресТаблицыНалоговыйАгентНДСВХранилище);
		ЭтотОбъект.НалоговыйАгентНДС.Очистить();
		ЭтотОбъект.НалоговыйАгентНДС.Загрузить(ТаблицаНалоговыйАгентНДС);
	КонецЕсли;
	
	РассчитатьИтог();
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, ЗавершениеРаботы, ТекстПредупреждения, СтандартнаяОбработка)
	
	Если ЗавершениеРаботы Тогда
		Возврат;
	КонецЕсли;
	
	Если Модифицированность Тогда
		Отказ = Истина;
		Оповещение = Новый ОписаниеОповещения("ВопросПередЗакрытиемЗавершение", ЭтотОбъект);
		ТекстВопроса = НСтр("ru = 'Данные были изменены. Сохранить изменения?'");
		ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНетОтмена);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаВыбора(ВыбранноеЗначение, ИсточникВыбора)
	
	Если ИсточникВыбора.ИмяФормы = "Обработка.ПодборНДСНалоговогоАгентаКУплате.Форма.Форма" Тогда
		ОбработкаВыбораПодборНаСервере(ВыбранноеЗначение);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОбработкаПроверкиЗаполненияНаСервере(Отказ, ПроверяемыеРеквизиты)
	
	Для Индекс = 0 По НалоговыйАгентНДС.Количество() - 1 Цикл
		
		СтрокаПлатежа = НалоговыйАгентНДС[Индекс];
		
		Префикс = "НалоговыйАгентНДС[%1]";
		Префикс = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			Префикс, Формат(Индекс, "ЧН=0; ЧГ="));
		
		ИмяСписка = НСтр("ru = 'Расшифровка платежа'");
		
		Если НЕ ЗначениеЗаполнено(СтрокаПлатежа.Контрагент) Тогда
			Поле = Префикс + ".Контрагент";
			ТекстСообщения = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Колонка",, НСтр("ru = 'Контрагент'"),
				Индекс + 1, ИмяСписка);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , Поле, , Отказ);
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(СтрокаПлатежа.Договор) Тогда
			Поле = Префикс + ".Договор";
			ТекстСообщения = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Колонка",, НСтр("ru = 'Договор'"),
				Индекс + 1, ИмяСписка);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , Поле, , Отказ);
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(СтрокаПлатежа.ДокументРасчетов) Тогда
			Поле = Префикс + ".ДокументРасчетов";
			ТекстСообщения = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Колонка",, НСтр("ru = 'Документ'"),
				Индекс + 1, ИмяСписка);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , Поле, , Отказ);
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(СтрокаПлатежа.Сумма) Тогда
			Поле = Префикс + ".Сумма";
			ТекстСообщения = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Колонка",, НСтр("ru = 'Сумма'"),
				Индекс + 1, ИмяСписка);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , Поле, , Отказ);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыНалоговыйАгентНДС

&НаКлиенте
Процедура НалоговыйАгентНДСДокументРасчетовНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	СтрокаПлатеж = Элементы.НалоговыйАгентНДС.ТекущиеДанные;
	СчетУчета = ЭтотОбъект.СчетУчета;
	
	Если НЕ ЗначениеЗаполнено(ЭтотОбъект.Период) Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Не указана дата.'"));
		Возврат;
	ИначеЕсли НЕ ЗначениеЗаполнено(ЭтотОбъект.Организация) Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Не указана организация.'"));
		Возврат;
	ИначеЕсли НЕ ЗначениеЗаполнено(СтрокаПлатеж.Контрагент) Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Не указан контрагент.'"));
		Возврат;
	ИначеЕсли НЕ ЗначениеЗаполнено(СтрокаПлатеж.Договор) Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Не указан договор.'"));
		Возврат;
	КонецЕсли;
	
	ПараметрыОбъекта = Новый Структура;
	ПараметрыОбъекта.Вставить("Дата",               ЭтотОбъект.Период);
	ПараметрыОбъекта.Вставить("ДоговорКонтрагента", СтрокаПлатеж.Договор);
	ПараметрыОбъекта.Вставить("Контрагент",         СтрокаПлатеж.Контрагент);
	ПараметрыОбъекта.Вставить("Организация",        ЭтотОбъект.Организация);
	ПараметрыОбъекта.Вставить("ОстаткиОбороты",     "Кт");
	ПараметрыОбъекта.Вставить("СчетУчета",          СчетУчета);
	ПараметрыОбъекта.Вставить("РежимОтбораДокументов", 
		ПредопределенноеЗначение("Перечисление.РежимОтбораДокументов.ПоОборотам"));
	ПараметрыОбъекта.Вставить("ТипыДокументов",
		"Метаданные.Документы." + ИмяДокумента + ".ТабличныеЧасти.НалоговыйАгентНДС.Реквизиты.ДокументРасчетов.Тип");
	
	ПараметрыФормы = Новый Структура("ПараметрыОбъекта", ПараметрыОбъекта);
	ОткрытьФорму("Документ.ДокументРасчетовСКонтрагентом.ФормаВыбора", ПараметрыФормы, Элемент);

КонецПроцедуры

&НаКлиенте
Процедура НалоговыйАгентНДСПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	
	РассчитатьИтог();
	
КонецПроцедуры

&НаКлиенте
Процедура НалоговыйАгентНДСПослеУдаления(Элемент, Отказ)
	
	РассчитатьИтог();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ОК(Команда)
	
	Если ПроверитьЗаполнение() Тогда
		ОповеститьОВыбореИЗакрыть();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура Подбор(Команда)
	
	ПараметрыФормы = Новый Структура();
	ПараметрыФормы.Вставить("ДатаДокумента",                           ЭтотОбъект.Период);
	ПараметрыФормы.Вставить("Организация",                             ЭтотОбъект.Организация);
	ПараметрыФормы.Вставить("АдресТаблицыНалоговыйАгентНДСВХранилище", ПоместитьРасшифровкуНалоговыйАгентНДСВХранилище());
	ПараметрыФормы.Вставить("ДокументСсылка",                          ЭтотОбъект.ДокументСсылка);
	ПараметрыФормы.Вставить("СчетУчета",                               ЭтотОбъект.СчетУчета);
	ПараметрыФормы.Вставить("ОграничитьПериодОсмотра",                 Ложь);
	
	ОткрытьФорму("Обработка.ПодборНДСНалоговогоАгентаКУплате.Форма.Форма", ПараметрыФормы, ЭтаФорма);

КонецПроцедуры

&НаКлиенте
Процедура Заполнить(Команда)
	
	Если ЭтотОбъект.НалоговыйАгентНДС.Количество() > 0 Тогда
		ОписаниеОповещения = Новый ОписаниеОповещения("ВопросЗаполнитьТаблицуЗавершение", ЭтотОбъект);
		ПоказатьВопрос(
			ОписаниеОповещения, 
			НСтр("ru='Перед заполнением табличная часть будет очищена. Заполнить?'"),
			РежимДиалогаВопрос.ДаНет, 60);
	Иначе
		ЗаполнитьНаСервере();
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура ОповеститьОВыбореИЗакрыть()
	
	ВыбранноеЗначение = Новый Структура;
	ВыбранноеЗначение.Вставить("КлючСтроки", КлючСтроки);
	ВыбранноеЗначение.Вставить("АдресТаблицыНалоговыйАгентНДСВХранилище", 
		ПоместитьРасшифровкуНалоговыйАгентНДСВХранилище());
	
	Модифицированность = Ложь;
	
	ОповеститьОВыборе(ВыбранноеЗначение);
	
КонецПроцедуры

&НаСервере
Процедура ОбработкаВыбораПодборНаСервере(ВыбранноеЗначение)
	
	ТаблицаНалоговыйАгентНДС = ПолучитьИзВременногоХранилища(ВыбранноеЗначение.АдресТаблицыНалоговыйАгентНДСВХранилище);
	Если ТаблицаНалоговыйАгентНДС.Количество() > 0 Тогда
		ЭтотОбъект.НалоговыйАгентНДС.Очистить();
		ЭтотОбъект.НалоговыйАгентНДС.Загрузить(ТаблицаНалоговыйАгентНДС);
		РассчитатьИтог();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНаСервере()
	
	РеквизитыДокумента = Новый Структура();
	РеквизитыДокумента.Вставить("ДатаДокумента",              ЭтотОбъект.Период);
	РеквизитыДокумента.Вставить("Организация",                ЭтотОбъект.Организация);
	РеквизитыДокумента.Вставить("ТекущийДокумент",            ЭтотОбъект.ДокументСсылка);
	РеквизитыДокумента.Вставить("СчетУчета",                  ЭтотОбъект.СчетУчета);
	РеквизитыДокумента.Вставить("ОграничитьПериодОсмотра",    Истина);
	
	ЗадолженностьНалоговогоАгентаПоНДС = УчетНДСБП.ЗадолженностьНалоговогоАгентаПоНДС(РеквизитыДокумента);
	
	ЭтотОбъект.НалоговыйАгентНДС.Очистить();
	ЭтотОбъект.НалоговыйАгентНДС.Загрузить(ЗадолженностьНалоговогоАгентаПоНДС);
	
	РассчитатьИтог();
	
КонецПроцедуры

&НаКлиенте
Процедура ВопросЗаполнитьТаблицуЗавершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	Если РезультатВопроса = КодВозвратаДиалога.Да Тогда
		ЭтотОбъект.НалоговыйАгентНДС.Очистить();
		ЗаполнитьНаСервере();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВопросПередЗакрытиемЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = КодВозвратаДиалога.Да И ПроверитьЗаполнение() Тогда
		ОповеститьОВыбореИЗакрыть();
	ИначеЕсли Результат = КодВозвратаДиалога.Нет Тогда
		Модифицированность = Ложь;
		Закрыть();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ПоместитьРасшифровкуНалоговыйАгентНДСВХранилище()
	
	ТаблицаНалоговыйАгентНДС = ЭтотОбъект.НалоговыйАгентНДС.Выгрузить();
	АдресТаблицыНалоговыйАгентНДСВХранилище = ПоместитьВоВременноеХранилище(ТаблицаНалоговыйАгентНДС, УникальныйИдентификатор);
	
	Возврат АдресТаблицыНалоговыйАгентНДСВХранилище;
	
КонецФункции

&НаСервере
Процедура РассчитатьИтог()
	
	ИтогПоТаблице = ЭтотОбъект.НалоговыйАгентНДС.Итог("Сумма");
	
КонецПроцедуры

#КонецОбласти